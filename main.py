import streamlit as st
import pandas as pd
import plotly.express as px

# -----------------------------------------------------------
# 1. ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬ í•¨ìˆ˜
# -----------------------------------------------------------

@st.cache_data
def load_data(file):
    """CSV íŒŒì¼ì„ ì½ê³  í•„ìš”í•œ ì»¬ëŸ¼ ì´ë¦„ì„ ì •ë¦¬í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤."""
    # ì¸ì½”ë”© ë¬¸ì œ ë°œìƒ ì‹œ 'cp949' ë˜ëŠ” 'latin1' ë“±ìœ¼ë¡œ ë³€ê²½í•´ ë³´ì„¸ìš”.
    df = pd.read_csv(file, encoding='utf-8')

    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒí•˜ê³  ì´ë¦„ ë³€ê²½ (ê°€ë…ì„± í–¥ìƒ)
    df = df.rename(columns={
        'ìì¹˜êµ¬_ì½”ë“œ_ëª…': 'ìì¹˜êµ¬ëª…',
        'ì„œë¹„ìŠ¤_ì—…ì¢…_ì½”ë“œ_ëª…': 'ì—…ì¢…ëª…',
        'ë‹¹ì›”_ë§¤ì¶œ_ê¸ˆì•¡': 'ì´_ë§¤ì¶œì•¡',
        'ë‹¹ì›”_ë§¤ì¶œ_ê±´ìˆ˜': 'ì´_ë§¤ì¶œê±´ìˆ˜',
        'ì—°ë ¹ëŒ€_10_ë§¤ì¶œ_ê¸ˆì•¡': '10ëŒ€_ë§¤ì¶œ',
        'ì—°ë ¹ëŒ€_20_ë§¤ì¶œ_ê¸ˆì•¡': '20ëŒ€_ë§¤ì¶œ',
        'ì—°ë ¹ëŒ€_30_ë§¤ì¶œ_ê¸ˆì•¡': '30ëŒ€_ë§¤ì¶œ',
        'ì—°ë ¹ëŒ€_40_ë§¤ì¶œ_ê¸ˆì•¡': '40ëŒ€_ë§¤ì¶œ',
        'ì—°ë ¹ëŒ€_50_ë§¤ì¶œ_ê¸ˆì•¡': '50ëŒ€_ë§¤ì¶œ',
        'ì—°ë ¹ëŒ€_60_ì´ìƒ_ë§¤ì¶œ_ê¸ˆì•¡': '60ëŒ€_ì´ìƒ_ë§¤ì¶œ'
    })
    return df

# -----------------------------------------------------------
# 2. ê°•ë‚¨êµ¬ ì¹´í˜ ë°ì´í„° ì¶”ì¶œ ë° ë¶„ì„ í•¨ìˆ˜
# -----------------------------------------------------------

def analyze_gangnam_cafe(df):
    """ê°•ë‚¨êµ¬ì˜ 'ì»¤í”¼ìŒë£Œì ' ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤."""
    
    # 1. ê°•ë‚¨êµ¬ì˜ 'ì»¤í”¼ìŒë£Œì ' ë°ì´í„° í•„í„°ë§
    df_gangnam_cafe = df[
        (df['ìì¹˜êµ¬ëª…'] == 'ê°•ë‚¨êµ¬') & 
        (df['ì—…ì¢…ëª…'] == 'ì»¤í”¼-ìŒë£Œ')
    ].copy()
    
    if df_gangnam_cafe.empty:
        st.error("â— ì˜¤ë¥˜: íŒŒì¼ì—ì„œ ê°•ë‚¨êµ¬ì˜ ì»¤í”¼-ìŒë£Œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None

    # 2. ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œì•¡ í•©ì‚° (íŒŒì¼ì´ ë¶„ê¸°ë³„ ë°ì´í„°ë¼ê³  ê°€ì •)
    age_cols = ['10ëŒ€_ë§¤ì¶œ', '20ëŒ€_ë§¤ì¶œ', '30ëŒ€_ë§¤ì¶œ', '40ëŒ€_ë§¤ì¶œ', '50ëŒ€_ë§¤ì¶œ', '60ëŒ€_ì´ìƒ_ë§¤ì¶œ']
    
    # í•´ë‹¹ ì—°ë ¹ëŒ€ ì»¬ëŸ¼ì˜ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° 0ìœ¼ë¡œ ì±„ìš°ê¸° (ì•ˆì „í•œ ì²˜ë¦¬ë¥¼ ìœ„í•´)
    for col in age_cols:
        if col not in df_gangnam_cafe.columns:
            df_gangnam_cafe[col] = 0
            
    # ëª¨ë“  ë¶„ê¸°ì˜ í•©ì‚° ëŒ€ì‹ , íŒŒì¼ì— ìˆëŠ” ë°ì´í„° (ê°€ì¥ ìµœê·¼ ë¶„ê¸° ë°ì´í„°ë¼ê³  ê°€ì •)ë¥¼ ì‚¬ìš©
    # ë§Œì•½ íŒŒì¼ì— ì—¬ëŸ¬ ë¶„ê¸°ê°€ ìˆë‹¤ë©´ ê°€ì¥ ìµœê·¼ ë¶„ê¸°(ê°€ì¥ í° 'ê¸°ì¤€_ë…„ë¶„ê¸°_ì½”ë“œ')ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ëª¨ë‘ í•©ì‚°í•´ì•¼ í•¨.
    
    # ì¼ë‹¨, í•„í„°ë§ëœ ë°ì´í„°ì˜ ì²« ë²ˆì§¸ í–‰ì„ ëŒ€í‘œ ë°ì´í„°ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    data_row = df_gangnam_cafe.iloc[0]

    # ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë°ì´í„°ë¥¼ ì‹œë¦¬ì¦ˆë¡œ ë³€í™˜
    age_sales = data_row[age_cols].sum()
    
    if age_sales == 0:
         st.warning("ê²½ê³ : ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œì•¡ í•©ê³„ê°€ 0ì…ë‹ˆë‹¤. ë°ì´í„°ê°€ ë¹„ì–´ ìˆê±°ë‚˜ ëˆ„ë½ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
         return None

    # ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë¹„ì¤‘ ê³„ì‚°
    age_sales_df = pd.DataFrame({
        'ì—°ë ¹ëŒ€': [c.replace('_ë§¤ì¶œ', '') for c in age_cols],
        'ë§¤ì¶œì•¡': data_row[age_cols].values
    })
    
    # ì´ ë§¤ì¶œ ë° ê±´ìˆ˜ (ëŒ€í‘œê°’)
    total_sales = data_row['ì´_ë§¤ì¶œì•¡']
    total_count = data_row['ì´_ë§¤ì¶œê±´ìˆ˜']

    return age_sales_df, total_sales, total_count

# -----------------------------------------------------------
# 3. Streamlit ì•± ë©”ì¸ í•¨ìˆ˜
# -----------------------------------------------------------

def main():
    st.set_page_config(layout="wide", page_title="ê°•ë‚¨êµ¬ ì¹´í˜ ìƒê¶Œ ë¶„ì„", initial_sidebar_state="expanded")
    st.title("â˜• ì„œìš¸ ê°•ë‚¨êµ¬ 'ì»¤í”¼-ìŒë£Œ' ìƒê¶Œ ë¶„ì„")
    st.markdown("---")

    # 1. ë°ì´í„° ë¡œë“œ
    file_path = "ì„œìš¸ì‹œ ìƒê¶Œë¶„ì„ì„œë¹„ìŠ¤(ì¶”ì •ë§¤ì¶œ-ìì¹˜êµ¬).csv"
    try:
        df = load_data(file_path)
    except FileNotFoundError:
        st.error(f"âŒ ì˜¤ë¥˜: íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. '{file_path}' ê²½ë¡œì— íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.")
        st.stop()
    except Exception as e:
        st.error(f"âŒ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        st.stop()

    # 2. ê°•ë‚¨êµ¬ ì¹´í˜ ë°ì´í„° ë¶„ì„
    analysis_result = analyze_gangnam_cafe(df)

    if analysis_result:
        age_sales_df, total_sales, total_count = analysis_result
        
        # 3. í•µì‹¬ ì§€í‘œ í‘œì‹œ
        col1, col2, col3 = st.columns(3)
        col1.metric("ğŸ“Š ë¶„ì„ ê¸°ì¤€ ë¶„ê¸°", str(df['ê¸°ì¤€_ë…„ë¶„ê¸°_ì½”ë“œ'].iloc[0]))
        col2.metric("ğŸ’° ì´ ì¶”ì • ë§¤ì¶œì•¡ (ì›)", f"{total_sales:,.0f}ì›")
        col3.metric("ğŸ›’ ì´ ë§¤ì¶œ ê±´ìˆ˜ (ê±´)", f"{total_count:,.0f}ê±´")
        st.markdown("---")
        
        # 4. ì‹œê°í™” (Plotly ì‚¬ìš©)
        st.header("ğŸ“ˆ ê°•ë‚¨êµ¬ ì¹´í˜ ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë¹„ì¤‘ ë¶„ì„")
        
        # Plotly Pie Chart (ì›í˜• ê·¸ë˜í”„)
        fig_pie = px.pie(
            age_sales_df, 
            values='ë§¤ì¶œì•¡', 
            names='ì—°ë ¹ëŒ€', 
            title='ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œì•¡ ì ìœ ìœ¨ (íŒŒì´ ì°¨íŠ¸)',
            hole=0.3, # ë„ë„› ëª¨ì–‘
            color_discrete_sequence=px.colors.qualitative.Pastel
        )
        fig_pie.update_traces(textinfo='percent+label', marker=dict(line=dict(color='#000000', width=1)))
        
        # Plotly Bar Chart (ë§‰ëŒ€ ê·¸ë˜í”„)
        fig_bar = px.bar(
            age_sales_df.sort_values(by='ë§¤ì¶œì•¡', ascending=False), 
            x='ì—°ë ¹ëŒ€', 
            y='ë§¤ì¶œì•¡', 
            title='ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œì•¡ (ë§‰ëŒ€ ì°¨íŠ¸)',
            color='ì—°ë ¹ëŒ€',
            color_discrete_sequence=px.colors.qualitative.Dark24,
            text='ë§¤ì¶œì•¡' # ë§‰ëŒ€ ìœ„ì— ë§¤ì¶œì•¡ í‘œì‹œ
        )
        fig_bar.update_traces(texttemplate='%{text:,.0f}', textposition='outside')
        fig_bar.update_layout(yaxis_title="ë§¤ì¶œì•¡ (ì›)", xaxis_title="ì—°ë ¹ëŒ€")

        col_left, col_right = st.columns(2)
        with col_left:
            st.plotly_chart(fig_pie, use_container_width=True)
        with col_right:
            st.plotly_chart(fig_bar, use_container_width=True)
            
        st.markdown("---")
        st.subheader("ğŸ’¡ ì—°ë ¹ëŒ€ë³„ ë§¤ì¶œ ë¶„ì„ ì‹œì‚¬ì ")
        
        # ë§¤ì¶œì•¡ì´ ê°€ì¥ ë†’ì€ ì—°ë ¹ëŒ€ ì¶”ì¶œ
        top_age = age_sales_df.loc[age_sales_df['ë§¤ì¶œì•¡'].idxmax()]
        
        st.info(
            f"**ê°€ì¥ ë†’ì€ ë§¤ì¶œì•¡ì„ ê¸°ë¡í•œ ì—°ë ¹ëŒ€:** {top_age['ì—°ë ¹ëŒ€']} ({top_age['ë§¤ì¶œì•¡']:,.0f}ì›)\n\n"
            f"ì´ëŠ” ê°•ë‚¨êµ¬ ì¹´í˜ ìƒê¶Œì—ì„œ í•´ë‹¹ ì—°ë ¹ì¸µì„ **í•µì‹¬ íƒ€ê²Ÿ**ìœ¼ë¡œ ì„¤ì •í•˜ê³ , ê·¸ë“¤ì˜ ì†Œë¹„ ì„±í–¥(ê³ ê¸‰í™”, íŠ¸ë Œë””í•¨, í¸ì˜ì„± ë“±)ì— ë§ëŠ” ì „ëµì„ ìˆ˜ë¦½í•´ì•¼ í•¨ì„ ì‹œì‚¬í•©ë‹ˆë‹¤."
        )

# -----------------------------------------------------------
# ì•± ì‹¤í–‰
# -----------------------------------------------------------
if __name__ == "__main__":
    main()
